___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Facebook CAPI Web Tag",
  "brand": {
    "id": "github.com_ftargeting",
    "displayName": "ftargeting",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIIAAACCCAYAAACKAxD9AAAACXBIWXMAABcRAAAXEQHKJvM/AAAJU0lEQVR4nO2dXWhcRRTHZ3eTtNt0u0lbWm+xdCs+qC0kBYsoxWzBl4LiFt/8wBREH/zaKsKCQlNF2BchBfvmR/Kg+FJIFPRJTV76UoUEKpUKbdZa15akzWap2+ZjV2Z7FreZO3fvx9y5M/eeHywbdnaTmzv/PXPmzMw5sUajQRAkHvk7gDRBISBNUAhIExQC0qQrrLfBKFSzhJAMPAYJIX3w8x7mzXymoWWGELJICJkihMyVi6k57ic0JRSzBqNQpZ2cbXsMMG8SSwVE0XyUi6kZ2f+zaLQVglGo0m/5MJHT8Z1oCWOCPsrF1GKH9yuHVkIwClVq2vOEkJxDEy+bSRDEmMLXeA9aCMEoVIfh2z/ENKoNtRRUDKOq+xXKCgHG/WGwACp/++0yTkVRLqamVLw45YQAAsjDI828QX/oTGRENUEoJQQYAkZCYgE6MQ6CUGLIUEIIMAMY1dAH8EoF/IeRoC8kUCHAMEBvwttMY7QoUX8oyOEiMCFA5G8sIsOAXU7BcCE9DhHIWoNRqFIr8DOKgIFaxikYKqUi1SLAUDARQV/AKdR3yMsMSEkTAqh8KqRTQr8YLxdTwzL+kBQhwLRwFEXgChp3yPntN/guBBDBl0wD4oRZurjmpxh8dRbBKUQReGfAbyfSN4tgFKrU0XmZaUC8UAHLIHz/gy8WASwBikA8abAMGdG/WbhFQJ9ACsJ9BqEWAUUgjZbP0CfqDwoTAjgyKAJ5DECIXghChgZQ5lwU4gT7dsVJemOMef18uU6WaoGs25wUsXopSggzCmwgFcqWZIw8s7+r9tjexI1H9yRW926L214XWVkjtb8W69fpz5fm6/G5hXr9Qrm+4/JCPXnlZoNcuVlnPuORo+ViasLLr/AsBKNQHQ3TMvILB7trrxzqWXpoZ3wn0yiAz88ulz749o7oxTY6rRz0ssnF0wEXWEoOhQjeP7Kh8tqhnp7uBEkS0nzoRBr8hazba3btLLatJGrNEw8kyO8nNlfeGOpJgwh0ZQjiN3KFEIZFpE+e2zh/5tVNJJ2MhcXJPeE22ORqaIAhQdvIIXUEf3xr0437++PbmUb9cTVEuLUI2pzgWU+bCLYyjeFgCAJ7jnAsBBiHtN1iFnIRtBh1GnV0JIS2wydaQn2CCIiAgO/mqJ+cWgRtTx/R2cHzB7vD6BPwyDuxCraFoLM1oH7BFy8lK0xDuHFkFZxYBG2twZvZnkqIpohOsG0VbAlBd2tAI4ZMQzSwbRXsWoScrtaALhxpHjH0iq2ppF0hBH5I0y3vPLXhlp5XLow9duIKHYUAUUQt4wa7++NkVzoWpZkCj45CsBNilnLSxg+efDBRk7WSuHS7cXPhVmOJaVjHxWv1zcyL/kOjjRmrZWo7Qsgxr2jCkf1d89Qw+HW1lVqj8tH3d3q+O7+aXKo1+gkh/cyb1CEHC4WmWArBKFS1dRIp+4yEb7OFT6eXKx//cEenezNsJYROPoK21oBy35aYL7uMvj63Mq+ZCCgDVkvUoRUCjR/4AR0O3j1zW1cHlNufXCHA9nRth4X9Bvdf88Tp6WXhO08lwt2nYHW3uB+KMj9dXFXZIewEt09RCA757W+dDQJJ805UoxAc8M9S45o2F8vHtF9NhQDeJWY3WUdtpXGbeVE/HFkE0zcjocC0b1EI0cP0aCIKIYKYOYw8IQg7d48oCdO/PCEwikFCBdO/PCHgjCHcdLYIItOxIMrC9DEjBDOzgYQOpo/NhIBEEBQC0gSFgDSx3KqmAp+9mLzwiBHf5PRSkt2xjYQQoTuUdvfHt599r7fENDjg9NTyjq/OrSh3zkJ5ITy+N7G8tTf2MNMQAF1x0rt3W7zXy1++vKDmMjYODZKh6fVUBIUgEZp/0Ycci0JAIUiklYRTRRghqFq7OAz8UlpTxSdj+pgRAuIff1yvO579yIInhKhlF5HCr3+uqbIDmqnzwBOC8FIxyN0M7orA9C9PCNxTs4g76GnpgNL4m8H0LwpBEterjX9VuRaz4/E8ITBeJeKN6T9WVxW5hdPMKxZCYBSDeIMW7lDkFpr2rakQwHR4WlxB7mXm6poqC02m1t5UCADjWSLuUejMpGm/WgnBVDmIcxQ6M1nhVZFFIUjg6mJ9WZFL4fapZXEvo1CdCzq1Hq+8XufPJciHT29gXvcC/Wa//k3N8WYXnyq7ueFYuZgyrbXRaRFkIujiXSrlI6Cnoc9eWmNe1whuDS6roYFYmRJEO2ataklbCgGKSuI0MhxwU+sRm8vQXHOCaIVlP9oRgqlzgWjFpNWwYEsIMO80jU8j2mA5LNgSAoBWQV9KdrYf2hICzD3RadQTW7U2nOxZ7GheEOWo8AJIXoQwhnsZtcP2l9e2EMDrRKugDxVfhEDuimEEfQVtyHeaMrbj5lyDtoW+IkTJrm/QwrEQ4A9gXEFt/K8WD2hbKDwCTLo5tuhKCBBtPMk0IEFTcVuVz/XZR3AcZ5kGJEiGnTiIQoQAaFsTMoRMwrYBV3gSAgwRx5kGRDYlr19Kz8fiy8UUDVqMMw2ILKhfkHM7JLQQlR8hj/5CYOR5W9SdIEQIoMYcrkVI55TTwBEPYRlT4JhcFsUgjfFyMSUsniM0dQ6YKJxJ+A/dkSz0PgvPoQRTmGNMAyKKWV7JPi/4kkwLxi0Ug3iaIvA6QzDDt6xqKAbh+CYC4nd6PRDDYXQgPTPupwiIjDyLsBKGswn30NmB6zUEu0hJuAmziQwGnRxzTPTsgIe0zKtU0eViitYSOsU0IuuhawcHRAWL7CA9BS8EQY7iUMFlkhbfEhE2dkIguZgh1jCIW97ugX4xjpeLKc8LSG4ILCk3DUmXi6ksTDGjbh1aViCw4wKBZ2eHcTAT0aVs6gscBStgmv9QFkqk6QdHknrHByIyXFALeLJcTGW87CoSiVL1GqiDBMPF4ZAKogKbfjOw51MZlKzy1gpCGYVqFg7UDDFv0ovW8bPRIBxBOyhd7q9NEBnYBTWsWSV7atXGZMYD3KJ83Ufy/6YXKoS8UajmQBDPMm9UgxKcHB8L2gF0ghZCaAecqwmjUO2DNYwcPAeZGHQaklVNyQ4EiUI7IbSAsXailS3MKFQHIUiVhecB5kNiqEBi6yl4zKg67jvBMgVvCBiEGAV97oPnFjwHtNRW02AROr31PGNWGCsMhF0IiE2w7iPSBIWANEEhIIQQQv4D8wEO4mJgh1EAAAAASUVORK5CYII\u003d"
  },
  "description": "Facebook CAPI 追蹤代碼的模板，提供給 ftargeting 訂閱用戶專用，使用此代碼可將網站事件數據，發送至 ftargeting 伺服器，再傳送至 Meta 的伺服器，建議務必搭配自訂網域來使用。",
  "containerContexts": [
    "WEB"
  ],
  "categories": [
    "ADVERTISING",
    "CONVERSIONS",
    "MARKETING"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "url",
    "displayName": "URL",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^https:\\/\\/.+"
        ],
        "errorMessage": "The value must be a valid URL."
      }
    ],
    "valueHint": "https://server.com/fca",
    "help": "請填入 Server 端的連結，測試帳戶可直接填入 ftargeting 的測試連結，若是付費用戶請務必使用自訂網域。"
  },
  {
    "type": "TEXT",
    "name": "id",
    "displayName": "Pixel ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "RADIO",
    "name": "radioButton",
    "displayName": "Event Name",
    "radioItems": [
      {
        "value": "standard",
        "displayValue": "Standard",
        "subParams": [
          {
            "type": "SELECT",
            "name": "standardEvent",
            "displayName": "Event",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "AddPaymentInfo",
                "displayValue": "AddPaymentInfo"
              },
              {
                "value": "AddToCart",
                "displayValue": "AddToCart"
              },
              {
                "value": "AddToWishlist",
                "displayValue": "AddToWishlist"
              },
              {
                "value": "CompleteRegistration",
                "displayValue": "CompleteRegistration"
              },
              {
                "value": "Contact",
                "displayValue": "Contact"
              },
              {
                "value": "CustomizeProduct",
                "displayValue": "CustomizeProduct"
              },
              {
                "value": "Donate",
                "displayValue": "Donate"
              },
              {
                "value": "FindLocation",
                "displayValue": "FindLocation"
              },
              {
                "value": "InitiateCheckout",
                "displayValue": "InitiateCheckout"
              },
              {
                "value": "Lead",
                "displayValue": "Lead"
              },
              {
                "value": "PageView",
                "displayValue": "PageView"
              },
              {
                "value": "Purchase",
                "displayValue": "Purchase"
              },
              {
                "value": "Schedule",
                "displayValue": "Schedule"
              },
              {
                "value": "Search",
                "displayValue": "Search"
              },
              {
                "value": "StartTrial",
                "displayValue": "StartTrial"
              },
              {
                "value": "SubmitApplication",
                "displayValue": "SubmitApplication"
              },
              {
                "value": "Subscribe",
                "displayValue": "Subscribe"
              },
              {
                "value": "ViewContent",
                "displayValue": "ViewContent"
              }
            ],
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      },
      {
        "value": "custom",
        "displayValue": "Custom",
        "subParams": [
          {
            "type": "TEXT",
            "name": "customEvent",
            "displayName": "",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "privacyGroup",
    "displayName": "Privacy",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "anonymiseIP",
        "checkboxText": "Anonymise IP address",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "anonymiseUserAgent",
        "checkboxText": "Anonymise user agent",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "requiredGroup",
    "displayName": "Required",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "eventId",
        "displayName": "Unique Event ID",
        "simpleValueType": true,
        "help": "Unique Event ID 參數是一個能夠唯一區分來自瀏覽器和伺服器，相同事件的識別符，是必要參數"
      },
      {
        "type": "TEXT",
        "name": "access_token",
        "displayName": "Access Token",
        "simpleValueType": true,
        "help": "使用 轉換 API 之前請先至 事件管理工具 \u003e 設定，點選 產生存取權杖，並輸入 權杖至此欄位。"
      },
      {
        "type": "TEXT",
        "name": "test_event_code",
        "displayName": "Test Event Code",
        "simpleValueType": true,
        "help": "Test Event Code 可進行傳送測試，測試代碼可在 事件管理工具 \u003e 測試事件 獲得。只在測試階段使用。"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "EventDataGroup",
    "displayName": "Event Data",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "eventDataTable",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Property Name",
            "name": "name",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add Property"
      }
    ],
    "help": "事件附帶的參數，可填入 currency、value (選填)"
  },
  {
    "type": "GROUP",
    "name": "UserDataGroup",
    "displayName": "User Data",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "userDataTable",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Property Name",
            "name": "name",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add Property"
      }
    ],
    "help": "使用者的資料，可填入 email、phone (選填)"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const encodeUriComponent=require("encodeUriComponent"),getCookieValues=require("getCookieValues"),getReferrerUrl=require("getReferrerUrl"),getType=require("getType"),getUrl=require("getUrl"),JSON=require("JSON"),makeTableMap=require("makeTableMap"),parseUrl=require("parseUrl"),sendPixel=require("sendPixel"),event=data.standardEvent||data.customEvent,eventId=data.eventId,access_token=data.access_token,test_event_code=data.test_event_code,id=data.id;const mergeObjects=(e,r)=>{for(let t in r)r.hasOwnProperty(t)&&(e[t]=r[t]);return e;};const properties1="object"===getType(data.eventData)?data.eventData:{},propertiesTable1=data.eventDataTable&&data.eventDataTable.length?makeTableMap(data.eventDataTable,"name","value"):{},mergedProperties1=mergeObjects(properties1,propertiesTable1),properties2="object"===getType(data.userData)?data.userData:{},propertiesTable2=data.userDataTable&&data.userDataTable.length?makeTableMap(data.userDataTable,"name","value"):{},mergedProperties2=mergeObjects(properties2,propertiesTable2);let puguh=parseUrl(getUrl()).href;const transformData=() =>{let transformedUrl=data.url+'?v=1&t=pp_capi';const parsedUrl=parseUrl(getUrl());const parameters=[ {key:'dl',value:parsedUrl.href}, {key:'dr',value:getReferrerUrl()}, {key:'en',value:event}, {key:'eid',value:eventId}, {key:'act',value:access_token}, {key:'tec',value:test_event_code}, {key:'fbc',value:getCookieValues('_fbc')}, {key:'fbp',value:getCookieValues('_fbp')}, {key:'pid',value:id}, {key:'aip',value:data.anonymiseIP}, {key:'aua',value:data.anonymiseUserAgent}];for(let parameter of parameters){if(parameter.value==undefined||parameter.value==''){continue;};transformedUrl+='&'+parameter.key+'='+encodeUriComponent(parameter.value); }let uscdud=0;for(let property in mergedProperties1){let value=mergedProperties1[property];if(['array','object'].indexOf(getType(value))>-1){value=JSON.stringify(value);};transformedUrl+='&cd['+property+']='+encodeUriComponent(value);uscdud=1; }for(let property in mergedProperties2){let value=mergedProperties2[property];if(['array','object'].indexOf(getType(value))>-1){value=JSON.stringify(value);};if(property=="email"){property="em";};if(property=="phone"){property="ph";};transformedUrl+='&ud['+property+']='+encodeUriComponent(value);uscdud=1; }if(uscdud==1){transformedUrl=transformedUrl+"&uscdud=1";}return transformedUrl;};const url=transformData();puguh.indexOf("gtm-msr")>-1||puguh.indexOf("msr.appspot.com")>-1||puguh.indexOf("id=GTM")>-1||sendPixel(url,data.gtmOnSuccess,data.gtmOnFailure);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_fbc"
              },
              {
                "type": 1,
                "string": "_fbp"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Standard Event
  code: |-
    const mockData = {
      id: '123',
      endpoint: 'www.test.com/collect',
      standardEvent: 'PageView'
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 27/01/2022, 09:43:27


